<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CampusMatrix - Admin Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js">
<style>
:root {
    --jet-stream: #BDD9D7;
    --blue-whale: #03363D;
    --light-bg: #f8fafc;
    --card-bg: #fff;
    --text-light: #64748b;
    --danger: #ef4444;
    --warning: #f59e0b;
    --success: #10b981;
    --info: #3b82f6;
    --accent: #8b5cf6;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    display: flex;
    min-height: 100vh;
    background: var(--light-bg);
    color: var(--blue-whale);
}

/* SIDEBAR */
aside {
    width: 280px;
    background: var(--blue-whale);
    color: var(--jet-stream);
    padding: 24px;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 100;
}

.logo {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 30px;
    display: flex;
    gap: 12px;
    align-items: center;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(189, 217, 215, 0.2);
}

.logo i {
    color: var(--jet-stream);
    font-size: 26px;
}

.menu {
    list-style: none;
    padding: 0;
    margin: 0;
    flex-grow: 1;
}

.menu-item {
    padding: 14px 16px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
    color: var(--jet-stream);
    text-decoration: none;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 15px;
}

.menu-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
}

.menu-item.active {
    background: rgba(255, 255, 255, 0.15);
    font-weight: 600;
}

.menu-item i {
    width: 20px;
    text-align: center;
    font-size: 16px;
}

.badge {
    background: var(--danger);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: auto;
}

.admin-footer {
    margin-top: auto;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.admin-info {
    margin-bottom: 15px;
}

.admin-email {
    font-weight: 700;
    font-size: 14px;
}

.admin-role {
    font-size: 12px;
    color: rgba(189, 217, 215, 0.8);
}

.logout-btn {
    width: 100%;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

/* MAIN CONTENT */
.content {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
    max-width: calc(100vw - 280px);
}

/* HEADER */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e5e7eb;
}

.header-title h1 {
    font-size: 32px;
    margin-bottom: 8px;
}

.header-title p {
    color: var(--text-light);
    font-size: 16px;
}

.header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

.search-box {
    position: relative;
    min-width: 300px;
}

.search-box i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

.search-box input {
    width: 100%;
    padding: 12px 12px 12px 40px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    transition: border 0.3s;
}

.search-box input:focus {
    outline: none;
    border-color: var(--jet-stream);
}

.view-user-btn {
    background: var(--jet-stream);
    color: var(--blue-whale);
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.view-user-btn:hover {
    background: #a8c9c7;
    transform: translateY(-1px);
}

/* STATS CARDS */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.stat-card h3 {
    font-size: 14px;
    color: var(--text-light);
    margin-bottom: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.stat-number {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--blue-whale);
}

.stat-trend {
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.stat-trend.positive {
    color: var(--success);
}

.stat-trend.negative {
    color: var(--danger);
}

/* QUICK ACTIONS */
.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 30px;
}

.action-card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb;
    padding: 20px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: left;
    border-left: 4px solid var(--jet-stream);
}

.action-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    border-color: var(--jet-stream);
    border-left-color: var(--blue-whale);
}

.action-card i {
    font-size: 24px;
    color: var(--blue-whale);
    background: var(--jet-stream);
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-card-content {
    flex: 1;
}

.action-card span {
    font-weight: 600;
    color: var(--blue-whale);
    display: block;
    margin-bottom: 4px;
}

.action-card p {
    font-size: 13px;
    color: var(--text-light);
    margin: 0;
}

/* TABLE STYLES */
.table-container {
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    overflow: hidden;
    margin-bottom: 30px;
}

.table-header {
    padding: 24px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    background: #f9fafb;
}

.table-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: var(--blue-whale);
    border-bottom: 2px solid #e5e7eb;
    background: #f9fafb;
}

td {
    padding: 16px;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
}

tr:hover {
    background: #f9fafb;
}

/* BADGES */
.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.badge-active {
    background: #d1fae5;
    color: #065f46;
}

.badge-blocked {
    background: #fee2e2;
    color: #991b1b;
}

.badge-pending {
    background: #fef3c7;
    color: #92400e;
}

.badge-admin {
    background: var(--blue-whale);
    color: white;
}

.badge-user {
    background: #dbeafe;
    color: #1e40af;
}

.badge-mod {
    background: #ddd6fe;
    color: #5b21b6;
}

.badge-sold {
    background: #d1fae5;
    color: #065f46;
}

.badge-expired {
    background: #fee2e2;
    color: #991b1b;
}

.badge-lost {
    background: #fef3c7;
    color: #92400e;
}

.badge-found {
    background: #dbeafe;
    color: #1e40af;
}

.badge-resolved {
    background: #dcfce7;
    color: #166534;
}

/* ACTION BUTTONS */
.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    text-decoration: none;
    white-space: nowrap;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.btn-view {
    background: var(--jet-stream);
    color: var(--blue-whale);
}

.btn-edit {
    background: var(--info);
    color: white;
}

.btn-block {
    background: var(--danger);
    color: white;
}

.btn-unblock {
    background: var(--success);
    color: white;
}

.btn-delete {
    background: #6b7280;
    color: white;
}

.btn-export {
    background: var(--blue-whale);
    color: white;
}

.btn-feature {
    background: var(--accent);
    color: white;
}

.btn-resolve {
    background: var(--success);
    color: white;
}

/* MODAL */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--blue-whale);
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-light);
    transition: color 0.3s;
}

.modal-close:hover {
    color: var(--blue-whale);
}

.modal-body {
    padding: 24px;
}

/* FORM STYLES */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--blue-whale);
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    transition: border 0.3s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--jet-stream);
    box-shadow: 0 0 0 3px rgba(189, 217, 215, 0.2);
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 30px;
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-row .form-group {
    flex: 1;
}

.permissions-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 10px;
}

.permission-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

/* CHARTS */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-header h3 {
    color: var(--blue-whale);
    font-size: 1.2rem;
}

/* REAL-TIME INDICATOR */
.real-time-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

.real-time-indicator .blink {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* LOADING SPINNER */
.loading {
    text-align: center;
    padding: 40px;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--jet-stream);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* EMPTY STATE */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 20px;
    color: #cbd5e1;
}

.empty-state h3 {
    color: var(--blue-whale);
    margin-bottom: 10px;
}

/* NOTIFICATION */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 20px;
    border-radius: 8px;
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 10000;
    animation: slideInRight 0.3s;
    max-width: 400px;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.notification.success {
    border-left: 4px solid var(--success);
}

.notification.error {
    border-left: 4px solid var(--danger);
}

.notification.warning {
    border-left: 4px solid var(--warning);
}

.notification.info {
    border-left: 4px solid var(--info);
}

/* RESPONSIVE */
@media (max-width: 1200px) {
    aside {
        width: 250px;
    }
    .content {
        max-width: calc(100vw - 250px);
    }
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 992px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .actions-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    body {
        flex-direction: column;
    }
    
    aside {
        width: 100%;
        padding: 20px;
        flex-direction: row;
        flex-wrap: wrap;
    }
    
    .logo {
        width: 100%;
        margin-bottom: 20px;
    }
    
    .menu {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .menu-item {
        flex: 1;
        min-width: 140px;
        justify-content: center;
        text-align: center;
    }
    
    .admin-footer {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .content {
        max-width: 100%;
        padding: 20px;
    }
    
    .header-actions {
        width: 100%;
        justify-content: space-between;
    }
    
    .search-box {
        min-width: 100%;
        order: 2;
        margin-top: 15px;
    }
}

@media (max-width: 576px) {
    .menu-item {
        min-width: 120px;
        padding: 12px;
        font-size: 14px;
    }
    
    .header-title h1 {
        font-size: 24px;
    }
    
    .stats-grid,
    .actions-grid {
        grid-template-columns: 1fr;
    }
    
    .table-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .table-controls {
        flex-direction: column;
        width: 100%;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .form-row {
        flex-direction: column;
    }
}
</style>
</head>

<body>
<!-- SIDEBAR -->
<aside>
    <div class="logo">
        <i class="fas fa-user-shield"></i>
        <span>CampusMatrix Admin</span>
    </div>

    <nav class="menu">
        <button class="menu-item active" onclick="loadSection('dashboard')">
            <i class="fas fa-gauge-high"></i>
            Dashboard
        </button>
        <button class="menu-item" onclick="loadSection('users')">
            <i class="fas fa-users"></i>
            User Management
            <span class="badge" id="usersBadge">0</span>
        </button>
        <button class="menu-item" onclick="loadSection('admins')">
            <i class="fas fa-user-shield"></i>
            Admin Management
        </button>
        <button class="menu-item" onclick="loadSection('marketplace')">
            <i class="fas fa-store"></i>
            Marketplace
            <span class="badge" id="marketplaceBadge">0</span>
        </button>
        <button class="menu-item" onclick="loadSection('lostfound')">
            <i class="fas fa-search"></i>
            Lost & Found
            <span class="badge" id="lostfoundBadge">0</span>
        </button>
        <button class="menu-item" onclick="loadSection('studypartner')">
            <i class="fas fa-user-friends"></i>
            Study Partners
            <span class="badge" id="studyBadge">0</span>
        </button>
        <button class="menu-item" onclick="loadSection('reports')">
            <i class="fas fa-flag"></i>
            Reports
            <span class="badge" id="reportsBadge">0</span>
        </button>
        <button class="menu-item" onclick="loadSection('settings')">
            <i class="fas fa-gear"></i>
            Settings
        </button>
        <a href="login.html" class="menu-item" target="_blank">
            <i class="fas fa-eye"></i>
            View User Dashboard
        </a>
    </nav>

    <div class="admin-footer">
        <div class="admin-info">
            <div class="admin-email" id="adminEmailDisplay">Loading...</div>
            <div class="admin-role" id="adminRoleDisplay">Administrator</div>
        </div>
        <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
</aside>

<!-- MAIN CONTENT -->
<div class="content" id="contentArea">
    <!-- DASHBOARD SECTION (Default) -->
    <section id="dashboardSection" class="content-section">
        <div class="header">
            <div class="header-title">
                <h1>Admin Dashboard</h1>
                <p>Welcome back! Real-time platform overview</p>
            </div>
            <div class="header-actions">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="globalSearch" placeholder="Search across platform...">
                </div>
                <div class="real-time-indicator" id="realtimeIndicator">
                    <div class="blink"></div>
                    LIVE
                </div>
            </div>
        </div>

        <!-- REAL-TIME STATS -->
        <div class="stats-grid" id="dashboardStats">
            <div class="stat-card">
                <h3><i class="fas fa-users"></i> Total Users</h3>
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-trend positive" id="userTrend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+0 today</span>
                </div>
            </div>
            
            <div class="stat-card">
                <h3><i class="fas fa-store"></i> Marketplace Listings</h3>
                <div class="stat-number" id="marketplaceCount">0</div>
                <div class="stat-trend positive" id="marketplaceTrend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+0 today</span>
                </div>
            </div>
            
            <div class="stat-card">
                <h3><i class="fas fa-search"></i> Lost & Found</h3>
                <div class="stat-number" id="lostFoundCount">0</div>
                <div class="stat-trend positive" id="lostFoundTrend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+0 today</span>
                </div>
            </div>
            
            <div class="stat-card">
                <h3><i class="fas fa-user-friends"></i> Study Partners</h3>
                <div class="stat-number" id="studyPartnerCount">0</div>
                <div class="stat-trend positive" id="studyTrend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+0 today</span>
                </div>
            </div>
        </div>

        <!-- QUICK ACTIONS -->
        <div class="actions-grid">
            <div class="action-card" onclick="loadSection('users')">
                <i class="fas fa-user-plus"></i>
                <div class="action-card-content">
                    <span>Manage Users</span>
                    <p>Add, block, or delete users</p>
                </div>
            </div>
            
            <div class="action-card" onclick="loadSection('admins')">
                <i class="fas fa-user-shield"></i>
                <div class="action-card-content">
                    <span>Admin Management</span>
                    <p>Add new admins & manage roles</p>
                </div>
            </div>
            
            <div class="action-card" onclick="loadSection('marketplace')">
                <i class="fas fa-store-alt"></i>
                <div class="action-card-content">
                    <span>Marketplace</span>
                    <p>Review listings & transactions</p>
                </div>
            </div>
            
            <div class="action-card" onclick="loadSection('lostfound')">
                <i class="fas fa-search-plus"></i>
                <div class="action-card-content">
                    <span>Lost & Found</span>
                    <p>Moderate lost/found items</p>
                </div>
            </div>
            
            <div class="action-card" onclick="loadSection('reports')">
                <i class="fas fa-flag"></i>
                <div class="action-card-content">
                    <span>Reports</span>
                    <p>Check user reports & issues</p>
                </div>
            </div>
            
            <div class="action-card" onclick="loadSection('settings')">
                <i class="fas fa-sliders"></i>
                <div class="action-card-content">
                    <span>Settings</span>
                    <p>Platform configuration</p>
                </div>
            </div>
        </div>

        <!-- CHARTS -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>User Activity (Last 7 Days)</h3>
                    <select id="chartPeriod" onchange="updateUserActivityChart()">
                        <option value="7">7 Days</option>
                        <option value="30">30 Days</option>
                        <option value="90">90 Days</option>
                    </select>
                </div>
                <canvas id="userActivityChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Platform Usage Distribution</h3>
                </div>
                <canvas id="platformUsageChart"></canvas>
            </div>
        </div>

        <!-- RECENT ACTIVITY -->
        <div class="table-container">
            <div class="table-header">
                <h3>Recent Activity</h3>
                <div class="table-controls">
                    <button class="btn btn-view" onclick="refreshActivity()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Action</th>
                        <th>Time</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activityTableBody">
                    <tr>
                        <td colspan="4" class="loading">
                            <div class="spinner"></div>
                            <p>Loading activity...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- USERS SECTION -->
    <section id="usersSection" class="content-section" style="display: none;">
        <div class="header">
            <div class="header-title">
                <h1>User Management</h1>
                <p>Manage all registered users on the platform</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-edit" onclick="showAddUserModal()">
                    <i class="fas fa-user-plus"></i> Add New User
                </button>
                <button class="btn btn-export" onclick="exportUsers()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                </div>
                <div class="table-controls">
                    <select id="userFilter" onchange="filterUsers()" class="form-control" style="padding: 8px 12px;">
                        <option value="all">All Users</option>
                        <option value="active">Active Only</option>
                        <option value="blocked">Blocked</option>
                        <option value="recent">Recent (Last 7 days)</option>
                    </select>
                    <button class="btn btn-view" onclick="refreshUsers()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- ADMIN MANAGEMENT SECTION -->
    <section id="adminsSection" class="content-section" style="display: none;">
        <div class="header">
            <div class="header-title">
                <h1>Admin Management</h1>
                <p>Manage administrators and their permissions</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-edit" onclick="showAddAdminModal()">
                    <i class="fas fa-user-plus"></i> Add New Admin
                </button>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="adminSearch" placeholder="Search admins...">
                </div>
                <div class="table-controls">
                    <select id="adminRoleFilter" onchange="filterAdmins()" class="form-control" style="padding: 8px 12px;">
                        <option value="all">All Roles</option>
                        <option value="SUPER_ADMIN">Super Admin</option>
                        <option value="ADMIN">Admin</option>
                        <option value="MODERATOR">Moderator</option>
                        <option value="SUPPORT">Support</option>
                    </select>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminsTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- MARKETPLACE SECTION -->
    <section id="marketplaceSection" class="content-section" style="display: none;">
        <div class="header">
            <div class="header-title">
                <h1>Marketplace Management</h1>
                <p>Manage marketplace listings and transactions</p>
            </div>
            <div class="header-actions">
                <select id="marketplaceFilter" onchange="filterMarketplace()" class="form-control" style="padding: 8px 12px;">
                    <option value="all">All Listings</option>
                    <option value="active">Active</option>
                    <option value="sold">Sold</option>
                    <option value="expired">Expired</option>
                    <option value="featured">Featured</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="marketplaceSearch" placeholder="Search listings..." onkeyup="filterMarketplace()">
                </div>
                <div class="table-controls">
                    <button class="btn btn-export" onclick="exportMarketplace()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-view" onclick="refreshMarketplace()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Item</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Seller</th>
                        <th>Status</th>
                        <th>Posted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marketplaceTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- LOST & FOUND SECTION -->
    <section id="lostfoundSection" class="content-section" style="display: none;">
        <div class="header">
            <div class="header-title">
                <h1>Lost & Found Management</h1>
                <p>Manage lost and found item reports</p>
            </div>
            <div class="header-actions">
                <select id="itemTypeFilter" onchange="filterLostFound()" class="form-control" style="padding: 8px 12px;">
                    <option value="all">All Items</option>
                    <option value="LOST">Lost Items</option>
                    <option value="FOUND">Found Items</option>
                    <option value="RESOLVED">Resolved</option>
                    <option value="ACTIVE">Active</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="lostFoundSearch" placeholder="Search items..." onkeyup="filterLostFound()">
                </div>
                <div class="table-controls">
                    <button class="btn btn-export" onclick="exportLostFound()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-view" onclick="refreshLostFound()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Item</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th>Reporter</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="lostFoundTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- STUDY PARTNER SECTION -->
    <section id="studypartnerSection" class="content-section" style="display: none;">
        <div class="header">
            <div class="header-title">
                <h1>Study Partner Management</h1>
                <p>Manage study partner requests and matches</p>
            </div>
            <div class="header-actions">
                <select id="studyFilter" onchange="filterStudyPartners()" class="form-control" style="padding: 8px 12px;">
                    <option value="all">All Requests</option>
                    <option value="ACTIVE">Active</option>
                    <option value="MATCHED">Matched</option>
                    <option value="COMPLETED">Completed</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="studySearch" placeholder="Search study partners..." onkeyup="filterStudyPartners()">
                </div>
                <div class="table-controls">
                    <button class="btn btn-export" onclick="exportStudyPartners()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-view" onclick="refreshStudyPartners()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Student</th>
                        <th>Subject</th>
                        <th>Department</th>
                        <th>Year</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studyTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- REPORTS SECTION -->
    <section id="reportsSection" class="content-section" style="display: none;">
        <div class="header">
            <div class="header-title">
                <h1>Reports Management</h1>
                <p>Review and manage user reports</p>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="reportsSearch" placeholder="Search reports...">
                </div>
                <div class="table-controls">
                    <select id="reportStatusFilter" onchange="filterReports()" class="form-control" style="padding: 8px 12px;">
                        <option value="all">All Reports</option>
                        <option value="PENDING">Pending</option>
                        <option value="RESOLVED">Resolved</option>
                        <option value="CLOSED">Closed</option>
                    </select>
                    <button class="btn btn-view" onclick="refreshReports()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Report Type</th>
                        <th>Reporter</th>
                        <th>Target</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- SETTINGS SECTION -->
    <section id="settingsSection" class="content-section" style="display: none;">
        <div class="header">
            <div class="header-title">
                <h1>Platform Settings</h1>
                <p>Configure platform settings and preferences</p>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>General Settings</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Platform Name</label>
                    <input type="text" id="platformName" value="CampusMatrix" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Maintenance Mode</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label class="switch">
                            <input type="checkbox" id="maintenanceMode">
                            <span class="slider"></span>
                        </label>
                        <span id="maintenanceStatus">Platform is live</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>New User Registration</label>
                    <select id="registrationMode" class="form-control">
                        <option value="open">Open Registration</option>
                        <option value="invite">Invite Only</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Default User Role</label>
                    <select id="defaultRole" class="form-control">
                        <option value="STUDENT">Student</option>
                        <option value="MODERATOR">Moderator</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Maximum Marketplace Listings per User</label>
                    <input type="number" id="maxListings" value="10" min="1" max="50" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Listing Expiration Days</label>
                    <input type="number" id="listingExpiry" value="30" min="1" max="365" class="form-control">
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-edit" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- MODALS -->
<!-- Add User Modal -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New User</h3>
            <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addUserForm">
                <div class="form-group">
                    <label for="userFullName">Full Name *</label>
                    <input type="text" id="userFullName" required class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="userEmail">Email *</label>
                    <input type="email" id="userEmail" required class="form-control">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="userDepartment">Department</label>
                        <input type="text" id="userDepartment" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="userYear">Year</label>
                        <select id="userYear" class="form-control">
                            <option value="">Select Year</option>
                            <option value="1">First Year</option>
                            <option value="2">Second Year</option>
                            <option value="3">Third Year</option>
                            <option value="4">Fourth Year</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="userPassword">Password *</label>
                    <input type="password" id="userPassword" required class="form-control">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-delete" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-edit">Add User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Admin Modal -->
<div id="addAdminModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Administrator</h3>
            <button class="modal-close" onclick="closeModal('addAdminModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addAdminForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="adminUsername">Username *</label>
                        <input type="text" id="adminUsername" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="adminEmail">Email *</label>
                        <input type="email" id="adminEmail" required class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="adminPassword">Password *</label>
                        <input type="password" id="adminPassword" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="adminConfirmPassword">Confirm Password *</label>
                        <input type="password" id="adminConfirmPassword" required class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="adminFullName">Full Name</label>
                        <input type="text" id="adminFullName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="adminPhone">Phone</label>
                        <input type="tel" id="adminPhone" class="form-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="adminRole">Role *</label>
                    <select id="adminRole" required class="form-control">
                        <option value="">Select Role</option>
                        <option value="SUPER_ADMIN">Super Admin</option>
                        <option value="ADMIN">Admin</option>
                        <option value="MODERATOR">Moderator</option>
                        <option value="SUPPORT">Support</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Permissions</label>
                    <div class="permissions-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm_users" checked>
                            <label for="perm_users">User Management</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_marketplace" checked>
                            <label for="perm_marketplace">Marketplace</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_lostfound" checked>
                            <label for="perm_lostfound">Lost & Found</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_study" checked>
                            <label for="perm_study">Study Partners</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_reports" checked>
                            <label for="perm_reports">Reports</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_settings">
                            <label for="perm_settings">Settings</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-delete" onclick="closeModal('addAdminModal')">Cancel</button>
                    <button type="submit" class="btn btn-edit">Create Admin</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalUserName">User Details</h3>
            <button class="modal-close" onclick="closeModal('userDetailsModal')">&times;</button>
        </div>
        <div class="modal-body" id="userDetailsContent">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Admin Details Modal -->
<div id="adminDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalAdminName">Admin Details</h3>
            <button class="modal-close" onclick="closeModal('adminDetailsModal')">&times;</button>
        </div>
        <div class="modal-body" id="adminDetailsContent">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 id="confirmTitle">Confirm Action</h3>
            <button class="modal-close" onclick="closeModal('confirmModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Are you sure you want to perform this action?</p>
            <div class="form-actions">
                <button type="button" class="btn btn-delete" onclick="closeModal('confirmModal')">Cancel</button>
                <button type="button" class="btn btn-edit" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    console.log("=== Dashboard Loading ===");
console.log("Token exists:", !!localStorage.getItem('adminToken'));
console.log("Admin info exists:", !!localStorage.getItem('adminInfo'));

// Catch ALL errors
window.addEventListener('error', function(e) {
    console.error("GLOBAL ERROR:", e.error);
    console.error("Error at:", e.filename, "line:", e.lineno);
    e.preventDefault(); // Prevent default error handling
});

// Override console.error to see all errors
const originalError = console.error;
console.error = function(...args) {
    originalError.apply(console, args);
    console.log("ERROR DETECTED - but NOT logging out");
    // Don't call logout() here!
};
    console.log("=== Admin Dashboard Script Loading ===");

// Add these debugging lines to track execution
window.addEventListener('error', function(event) {
    console.error("JavaScript Error:", event.error);
    console.error("Error at:", event.filename, "line:", event.lineno);
    
    // Don't logout on JavaScript errors!
    // Just show a notification instead
    showNotification('JavaScript error occurred. Please refresh the page.', 'error');
    event.preventDefault(); // Prevent default error handling
});

// Override global error handling to prevent auto-logout
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.log('Error caught:', msg);
    return true; // Return true to prevent the default error handler
};
// ==================== CONFIGURATION ====================
const API_BASE_URL = 'http://localhost:8080/api';
const ADMIN_API_URL = `${API_BASE_URL}/admin`;
let currentToken = localStorage.getItem('adminToken');
let currentAdmin = null;
let charts = {};
let socket = null;

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    setupEventListeners();
    setupWebSocket();
});

function checkAuth() {
    console.log("=== checkAuth() called ===");
    
    const token = localStorage.getItem('adminToken');
    const adminInfo = localStorage.getItem('adminInfo');
    
    console.log("Token:", token ? "Present" : "Missing");
    console.log("Admin Info:", adminInfo ? "Present" : "Missing");
    
    if (!token) {
        console.log("No token - redirecting to login");
        window.location.href = 'admin-login.html';
        return;
    }
    
    if (!adminInfo) {
        console.log("No admin info - but token exists, using defaults");
        currentAdmin = {
            id: 1,
            username: 'admin',
            email: 'admin@campus.edu',
            role: 'SUPER_ADMIN'
        };
    } else {
        try {
            currentAdmin = JSON.parse(adminInfo);
            console.log("Admin info parsed:", currentAdmin);
        } catch (e) {
            console.error("Error parsing admin info:", e);
            currentAdmin = {
                id: 1,
                username: 'admin',
                email: 'admin@campus.edu',
                role: 'SUPER_ADMIN'
            };
        }
    }
    
    console.log("Auth check passed, loading dashboard...");
    updateAdminUI();
    loadDashboardData();
}




function updateAdminUI() {
    if (currentAdmin) {
        document.getElementById('adminEmailDisplay').textContent = currentAdmin.email || 'admin@campus.edu';
        document.getElementById('adminRoleDisplay').textContent = currentAdmin.role || 'ADMIN';
        
        // Disable super admin features if not super admin
        if (currentAdmin.role !== 'SUPER_ADMIN') {
            const adminSectionBtn = document.querySelector('[onclick="loadSection(\'admins\')"]');
            const settingsSectionBtn = document.querySelector('[onclick="loadSection(\'settings\')"]');
            
            if (adminSectionBtn) adminSectionBtn.style.display = 'none';
            if (settingsSectionBtn) settingsSectionBtn.style.display = 'none';
        }
    }
}

function setupEventListeners() {
    // Menu item clicks
    document.querySelectorAll('.menu-item').forEach(item => {
        if (item.onclick) return; // Skip if already has onclick
        
        const section = item.textContent.toLowerCase().replace(/\s+/g, '');
        item.addEventListener('click', () => loadSection(section));
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // Global search
    document.getElementById('globalSearch').addEventListener('input', performGlobalSearch);
    
    // Form submissions
    document.getElementById('addUserForm')?.addEventListener('submit', handleAddUser);
    document.getElementById('addAdminForm')?.addEventListener('submit', handleAddAdmin);
}

// ==================== WEBSOCKET ====================
function setupWebSocket() {
    console.log("WebSocket setup called");
    
    // Check if WebSocket is supported
    if (!window.WebSocket) {
        console.log("WebSocket not supported in this browser");
        return;
    }
    
    try {
        const wsUrl = `ws://localhost:8080/ws/admin?token=${currentToken}`;
        socket = new WebSocket(wsUrl);
        
        socket.onopen = () => {
            console.log('WebSocket connected');
            document.getElementById('realtimeIndicator').style.display = 'flex';
        };
        
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleRealTimeUpdate(data);
        };
        
        socket.onclose = () => {
            console.log('WebSocket disconnected - NOT reconnecting');
            document.getElementById('realtimeIndicator').style.display = 'none';
            // DON'T reconnect - just leave it disconnected
        };
        
        socket.onerror = (error) => {
            console.log('WebSocket connection failed (normal if not configured)');
            // Don't show error, just ignore it
        };
        
    } catch (error) {
        console.log("WebSocket setup failed:", error);
        // Ignore WebSocket errors
    }
}

function handleRealTimeUpdate(data) {
    switch(data.type) {
        case 'STATS_UPDATE':
            updateDashboardStats(data.data);
            break;
        case 'NEW_USER':
            showNotification(`New user registered: ${data.data.name}`, 'info');
            loadDashboardData();
            break;
        case 'NEW_LISTING':
            showNotification(`New marketplace listing: ${data.data.title}`, 'info');
            break;
        case 'NEW_REPORT':
            showNotification(`New report submitted`, 'warning');
            break;
        case 'USER_BLOCKED':
        case 'USER_UNBLOCKED':
            loadDashboardData();
            break;
    }
}

// ==================== DASHBOARD FUNCTIONS ====================
async function loadDashboardData() {
    console.log("Loading dashboard data...");
    
    try {
        const response = await fetch(`${ADMIN_API_URL}/dashboard/stats`, {
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const stats = await response.json();
            console.log("Dashboard stats:", stats);
            updateDashboardStats(stats);
        } else {
            console.warn("Dashboard stats API error:", response.status);
            // Use fallback data
            updateDashboardStats({
                totalUsers: 0,
                newUsersToday: 0,
                totalMarketplaceItems: 0,
                activeListings: 0,
                totalItems: 0,
                totalStudyPartners: 0,
                activeStudyRequests: 0
            });
        }
        
        // Initialize charts
        updateUserActivityChart();
        updatePlatformUsageChart();
        
        // Load activities - this might fail, but that's OK
        try {
            await loadRecentActivity();
        } catch (activityError) {
            console.log("Could not load activities:", activityError);
            // Continue without activities
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        // Don't logout, just show notification
        showNotification('Dashboard data temporarily unavailable', 'warning');
        
        // Use fallback data
        updateDashboardStats({
            totalUsers: 0,
            newUsersToday: 0,
            totalMarketplaceItems: 0,
            activeListings: 0,
            totalItems: 0,
            totalStudyPartners: 0,
            activeStudyRequests: 0
        });
        
        updateUserActivityChart();
        updatePlatformUsageChart();
        showFallbackActivity();
    }
}

function updateDashboardStats(stats) {
    // User stats
    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
    document.getElementById('usersBadge').textContent = stats.totalUsers || 0;
    document.getElementById('userTrend').innerHTML = `
        <i class="fas fa-arrow-up"></i>
        <span>+${stats.newUsersToday || 0} today</span>
    `;
    
    // Marketplace stats
    document.getElementById('marketplaceCount').textContent = stats.totalMarketplaceItems || 0;
    document.getElementById('marketplaceBadge').textContent = stats.activeListings || 0;
    
    // Lost & Found stats
    document.getElementById('lostFoundCount').textContent = stats.totalItems || 0;
    document.getElementById('lostfoundBadge').textContent = stats.totalItems || 0;
    
    // Study Partner stats
    document.getElementById('studyPartnerCount').textContent = stats.totalStudyPartners || 0;
    document.getElementById('studyBadge').textContent = stats.activeStudyRequests || 0;
}

function updateUserActivityChart() {
    const ctx = document.getElementById('userActivityChart').getContext('2d');
    
    if (charts.userActivity) {
        charts.userActivity.destroy();
    }
    
    // Sample data - replace with real data from API
    charts.userActivity = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'New Users',
                data: [12, 19, 15, 25, 22, 30, 28],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Active Users',
                data: [100, 120, 115, 130, 125, 140, 135],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
}

function updatePlatformUsageChart() {
    const ctx = document.getElementById('platformUsageChart').getContext('2d');
    
    if (charts.platformUsage) {
        charts.platformUsage.destroy();
    }
    
    charts.platformUsage = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Marketplace', 'Lost & Found', 'Study Partners', 'Chat', 'Profile'],
            datasets: [{
                data: [30, 25, 20, 15, 10],
                backgroundColor: [
                    '#3b82f6',
                    '#8b5cf6',
                    '#10b981',
                    '#f59e0b',
                    '#ef4444'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

async function loadRecentActivity() {
    console.log("Loading recent activity...");
    
    try {
        // Check if this endpoint exists - if not, use fallback
        const response = await fetch(`${ADMIN_API_URL}/activities/recent?size=10`, {
            headers: getAuthHeaders()
        });
        
        const tbody = document.getElementById('activityTableBody');
        tbody.innerHTML = '';
        
        if (response.ok) {
            const data = await response.json();
            const activities = data.content || [];
            
            if (activities.length === 0) {
                showFallbackActivity();
                return;
            }
            
            activities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${activity.adminName || 'System'}</strong><br>
                        <small>${activity.adminEmail || ''}</small>
                    </td>
                    <td>${activity.displayAction || activity.action || 'Action'}</td>
                    <td>${activity.timeAgo || formatTime(activity.timestamp) || 'Recently'}</td>
                    <td>${activity.details || ''}</td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`Loaded ${activities.length} recent activities`);
            
        } else if (response.status === 404) {
            // Endpoint doesn't exist - use fallback
            console.log("Activities endpoint not found, using fallback");
            showFallbackActivity();
        } else {
            // Other error
            console.error("Failed to load activities:", response.status);
            showFallbackActivity();
        }
        
    } catch (error) {
        console.error('Error loading activity:', error);
        // Don't logout, just show fallback
        showFallbackActivity();
    }
}

function showFallbackActivity() {
    const tbody = document.getElementById('activityTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="4" class="empty-state">
                <i class="fas fa-info-circle"></i>
                <p>Activity log coming soon</p>
                <small>Feature under development</small>
            </td>
        </tr>
    `;
}

function showFallbackActivity() {
    const tbody = document.getElementById('activityTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="4" class="empty-state">
                <i class="fas fa-sync-alt fa-spin"></i>
                <p>Loading activity log...</p>
                <small>Please wait</small>
            </td>
        </tr>
    `;
}

// ==================== USER MANAGEMENT ====================
async function loadUsers() {
    try {
        const response = await fetch(`${ADMIN_API_URL}/users?page=0&size=50`, {
            headers: getAuthHeaders()
        });
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        
        if (response.ok) {
            const data = await response.json();
            const users = data.content || [];
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-users-slash"></i>
                            <p>No users found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>
                        <strong>${user.name || user.username}</strong>
                    </td>
                    <td>${user.email}</td>
                    <td>${user.department || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${user.active ? 'badge-active' : 'badge-blocked'}">
                            ${user.active ? 'Active' : 'Blocked'}
                        </span>
                    </td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewUser(${user.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn ${user.active ? 'btn-block' : 'btn-unblock'}" 
                                    onclick="toggleUserStatus(${user.id}, ${user.active})">
                                <i class="fas ${user.active ? 'fa-ban' : 'fa-unlock'}"></i>
                            </button>
                            ${currentAdmin.role === 'SUPER_ADMIN' ? `
                                <button class="btn btn-delete" onclick="deleteUser(${user.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading users:', error);
        showNotification('Failed to load users', 'error');
    }
}

async function viewUser(userId) {
    try {
        const response = await fetch(`${ADMIN_API_URL}/users/${userId}`, {
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const user = await response.json();
            
            document.getElementById('modalUserName').textContent = user.name || user.username;
            
            const content = `
                <div class="user-details">
                    <div class="user-header">
                        <div class="user-avatar" style="width: 80px; height: 80px; background: var(--blue-whale); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold;">
                            ${user.name?.charAt(0) || user.username?.charAt(0) || 'U'}
                        </div>
                        <div class="user-info">
                            <h3>${user.name || user.username}</h3>
                            <p>${user.email}</p>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <span class="status-badge ${user.active ? 'badge-active' : 'badge-blocked'}">
                                    ${user.active ? 'Active' : 'Blocked'}
                                </span>
                                <span class="status-badge ${user.role ? 'badge-admin' : 'badge-user'}">
                                    ${user.role || 'Student'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-details-grid">
                        <div class="detail-item">
                            <strong>ID:</strong>
                            <span>${user.id}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Department:</strong>
                            <span>${user.department || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Created:</strong>
                            <span>${formatDate(user.createdAt)}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Last Login:</strong>
                            <span>${user.lastLogin ? formatDate(user.lastLogin) : 'Never'}</span>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn ${user.active ? 'btn-block' : 'btn-unblock'}" 
                                onclick="toggleUserStatus(${user.id}, ${user.active}); closeModal('userDetailsModal')">
                            <i class="fas ${user.active ? 'fa-ban' : 'fa-unlock'}"></i>
                            ${user.active ? 'Block User' : 'Unblock User'}
                        </button>
                        ${currentAdmin.role === 'SUPER_ADMIN' ? `
                            <button class="btn btn-delete" onclick="deleteUser(${user.id}); closeModal('userDetailsModal')">
                                <i class="fas fa-trash"></i> Delete User
                            </button>
                        ` : ''}
                        <button class="btn btn-view" onclick="closeModal('userDetailsModal')">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('userDetailsContent').innerHTML = content;
            showModal('userDetailsModal');
        }
    } catch (error) {
        console.error('Error viewing user:', error);
        showNotification('Failed to load user details', 'error');
    }
}

async function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'block' : 'unblock';
    
    showConfirm(
        `${action.charAt(0).toUpperCase() + action.slice(1)} User`,
        `Are you sure you want to ${action} this user?`,
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/users/${userId}/${action}`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification(`User ${action}ed successfully`, 'success');
                    loadUsers();
                    loadDashboardData();
                } else {
                    throw new Error('Failed to update user');
                }
            } catch (error) {
                console.error('Error toggling user status:', error);
                showNotification(`Failed to ${action} user`, 'error');
            }
        }
    );
}

async function deleteUser(userId) {
    console.log("Attempting to delete user:", userId);
    
    // Check if current admin has SUPER_ADMIN role
    if (currentAdmin.role !== 'SUPER_ADMIN') {
        showNotification('Access denied: Only Super Admins can delete users', 'error');
        return;
    }
    
    showConfirm(
        'Delete User',
        'Are you sure you want to delete this user? This action cannot be undone.',
        async () => {
            try {
                console.log("Sending delete request for user:", userId);
                const response = await fetch(`${ADMIN_API_URL}/users/${userId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                console.log("Delete response status:", response.status);
                
                if (response.ok) {
                    showNotification('User deleted successfully', 'success');
                    loadUsers();
                    loadDashboardData();
                } else if (response.status === 403) {
                    showNotification('Access denied: You need Super Admin privileges to delete users', 'error');
                } else {
                    const errorText = await response.text();
                    console.error("Delete failed:", errorText);
                    showNotification(`Failed to delete user: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('Failed to delete user', 'error');
            }
        }
    );
}

async function handleAddUser(e) {
    e.preventDefault();
    
    const userData = {
        fullName: document.getElementById('userFullName').value,
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value,
        department: document.getElementById('userDepartment').value,
        year: document.getElementById('userYear').value
    };
    
    try {
        const response = await fetch(`${ADMIN_API_URL}/users`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify(userData)
        });
        
        if (response.ok) {
            showNotification('User added successfully', 'success');
            closeModal('addUserModal');
            loadUsers();
            loadDashboardData();
        } else {
            const error = await response.text();
            throw new Error(error);
        }
    } catch (error) {
        console.error('Error adding user:', error);
        showNotification(`Failed to add user: ${error.message}`, 'error');
    }
}

// ==================== ADMIN MANAGEMENT ====================
async function loadAdmins() {
    if (currentAdmin.role !== 'SUPER_ADMIN') {
        showNotification('Access denied: Super Admin only', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${ADMIN_API_URL}/admins`, {
            headers: getAuthHeaders()
        });
        
        const tbody = document.getElementById('adminsTableBody');
        tbody.innerHTML = '';
        
        if (response.ok) {
            const admins = await response.json();
            
            if (admins.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-user-shield"></i>
                            <p>No admins found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            admins.forEach(admin => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${admin.id}</td>
                    <td>${admin.username}</td>
                    <td>${admin.fullName || 'N/A'}</td>
                    <td>${admin.email}</td>
                    <td>
                        <span class="status-badge badge-admin">
                            ${admin.role}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${admin.active ? 'badge-active' : 'badge-blocked'}">
                            ${admin.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${admin.lastLogin ? formatDate(admin.lastLogin) : 'Never'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewAdmin(${admin.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${admin.id !== currentAdmin.id ? `
                                <button class="btn ${admin.active ? 'btn-block' : 'btn-unblock'}" 
                                        onclick="toggleAdminStatus(${admin.id}, ${admin.active})">
                                    <i class="fas ${admin.active ? 'fa-ban' : 'fa-unlock'}"></i>
                                </button>
                                <button class="btn btn-delete" onclick="deleteAdmin(${admin.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading admins:', error);
        showNotification('Failed to load admins', 'error');
    }
}

async function handleAddAdmin(e) {
    e.preventDefault();
    
    if (currentAdmin.role !== 'SUPER_ADMIN') {
        showNotification('Access denied: Super Admin only', 'error');
        return;
    }
    
    const password = document.getElementById('adminPassword').value;
    const confirmPassword = document.getElementById('adminConfirmPassword').value;
    
    if (password !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    const adminData = {
        username: document.getElementById('adminUsername').value,
        password: password,
        email: document.getElementById('adminEmail').value,
        fullName: document.getElementById('adminFullName').value,
        phone: document.getElementById('adminPhone').value,
        role: document.getElementById('adminRole').value,
        permissions: Array.from(document.querySelectorAll('.permission-item input:checked'))
            .map(input => input.id.replace('perm_', ''))
    };
    
    try {
        const response = await fetch(`${ADMIN_API_URL}/admins`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify(adminData)
        });
        
        if (response.ok) {
            showNotification('Admin added successfully', 'success');
            closeModal('addAdminModal');
            loadAdmins();
        } else {
            const error = await response.text();
            throw new Error(error);
        }
    } catch (error) {
        console.error('Error adding admin:', error);
        showNotification(`Failed to add admin: ${error.message}`, 'error');
    }
}

// ==================== MARKETPLACE MANAGEMENT ====================
async function loadMarketplace() {
    try {
        const response = await fetch(`${ADMIN_API_URL}/marketplace/items?page=0&size=50`, {
            headers: getAuthHeaders()
        });
        
        const tbody = document.getElementById('marketplaceTableBody');
        tbody.innerHTML = '';
        
        if (response.ok) {
            const data = await response.json();
            const items = data.content || [];
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-store-slash"></i>
                            <p>No marketplace items found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>
                        <strong>${item.title}</strong><br>
                        <small>${item.description?.substring(0, 50)}...</small>
                    </td>
                    <td>${item.category}</td>
                    <td>${item.price}</td>
                    <td>${item.sellerName || 'Unknown'}</td>
                    <td>
                        <span class="status-badge ${item.sold ? 'badge-sold' : item.expired ? 'badge-expired' : 'badge-active'}">
                            ${item.sold ? 'Sold' : item.expired ? 'Expired' : 'Active'}
                        </span>
                    </td>
                    <td>${formatDate(item.createdAt)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewMarketplaceItem(${item.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${!item.featured ? `
                                <button class="btn btn-feature" onclick="toggleFeatured(${item.id})">
                                    <i class="fas fa-star"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-delete" onclick="deleteMarketplaceItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading marketplace:', error);
        showNotification('Failed to load marketplace items', 'error');
    }
}


// ==================== LOST & FOUND MANAGEMENT ====================
// ==================== LOST & FOUND MANAGEMENT ====================
async function loadLostFound() {
    try {
        console.log("Loading lost & found items...");
        const response = await fetch(`${ADMIN_API_URL}/items?page=0&size=50`, {
            headers: getAuthHeaders()
        });
        
        console.log("API Response Status:", response.status);
        
        const tbody = document.getElementById('lostFoundTableBody');
        tbody.innerHTML = '';
        
        if (response.ok) {
            const data = await response.json();
            console.log("API Response Data:", data);
            
            const items = data.content || data || [];
            console.log("Items array:", items);
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-search-slash"></i>
                            <p>No lost & found items found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            items.forEach(item => {
                console.log("Processing item:", item);
                
                // TRY DIFFERENT FIELD NAMES
                const itemName = item.itemName || item.title || item.name || 'Unnamed Item';
                const reporterName = item.reporterName || 
                     item.user?.fullName || 
                     item.user?.name || 
                     item.user?.username || 
                      item.contactName || item.user?.fullName ||
                     item.userName || 
                     item.ownerName || 
                     item.postedBy || 
                     item.createdBy || 
                     'Unknown';
                const description = item.description || item.details || '';
                const location = item.location || item.place || 'Unknown Location';
                const type = item.type || 'UNKNOWN';
                const isResolved = item.resolved || item.status === 'RESOLVED' || false;
                const date = item.date || item.createdAt || item.postedDate;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id || 'N/A'}</td>
                    <td>
                        <strong>${itemName}</strong><br>
                        <small>${description.substring(0, 50)}${description.length > 50 ? '...' : ''}</small>
                    </td>
                    <td>
                        <span class="status-badge ${type === 'LOST' ? 'badge-lost' : 'badge-found'}">
                            ${type}
                        </span>
                    </td>
                    <td>${location}</td>
                    <td>${reporterName}</td>
                    <td>
                        <span class="status-badge ${isResolved ? 'badge-resolved' : 'badge-pending'}">
                            ${isResolved ? 'Resolved' : 'Pending'}
                        </span>
                    </td>
                    <td>${formatDate(date)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewLostFoundItem(${item.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${!isResolved ? `
                                <button class="btn btn-resolve" onclick="resolveLostFoundItem(${item.id})">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-delete" onclick="deleteLostFoundItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            console.error("API Error Status:", response.status);
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading items</p>
                        <small>Status: ${response.status}</small>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading lost & found:', error);
        showNotification('Failed to load lost & found items', 'error');
        
        const tbody = document.getElementById('lostFoundTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Network error</p>
                </td>
            </tr>
        `;
    }
}

// ==================== STUDY PARTNER MANAGEMENT ====================
async function loadStudyPartners() {
    try {
        console.log("=== DEBUG: Loading Study Partners ===");
        const response = await fetch(`${ADMIN_API_URL}/study-partners?page=0&size=50`, {
            headers: getAuthHeaders()
        });
        
        console.log("Response status:", response.status);
        
        const tbody = document.getElementById('studyTableBody');
        tbody.innerHTML = '';
        
        if (response.ok) {
            const data = await response.json();
            console.log("Study Partners API Response:", data);
            
            // Check structure
            const partners = data.content || data || [];
            
            if (partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-user-friends-slash"></i>
                            <p>No study partner requests found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Debug first item
            if (partners[0]) {
                console.log("First study partner:", partners[0]);
                console.log("All fields:", Object.keys(partners[0]));
                
                // Check for user object
                if (partners[0].user) {
                    console.log("User object found:", partners[0].user);
                }
            }
            
            partners.forEach(partner => {
                console.log("Partner:", partner);
                
                // Try different field names for student name
                const studentName = partner.studentName || 
                                   partner.user?.fullName || 
                                   partner.user?.name || 
                                   partner.userName || 
                                   partner.contactName || 
                                   'Unknown Student';
                
                console.log("Extracted studentName:", studentName);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${partner.id}</td>
                    <td style="color: red; font-weight: bold;">${studentName}</td>
                    <td>${partner.subject}</td>
                    <td>${partner.department}</td>
                    <td>${partner.year}</td>
                    <td>
                        <span class="status-badge ${partner.status === 'MATCHED' ? 'badge-resolved' : partner.status === 'COMPLETED' ? 'badge-sold' : 'badge-active'}">
                            ${partner.status}
                        </span>
                    </td>
                    <td>${formatDate(partner.createdAt)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewStudyPartner(${partner.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-delete" onclick="deleteStudyPartner(${partner.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
        } else {
            console.error("Failed to load study partners:", response.status);
            showNotification('Failed to load study partners', 'error');
        }
    } catch (error) {
        console.error('Error loading study partners:', error);
        showNotification('Failed to load study partners', 'error');
    }
}

// ==================== REPORTS MANAGEMENT ====================
async function loadReports() {
    try {
        const response = await fetch(`${ADMIN_API_URL}/reports?page=0&size=50`, {
            headers: getAuthHeaders()
        });
        
        const tbody = document.getElementById('reportsTableBody');
        tbody.innerHTML = '';
        
        if (response.ok) {
            const reports = await response.json();
            
            if (reports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-flag-slash"></i>
                            <p>No reports found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            reports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.id}</td>
                    <td>${report.type}</td>
                    <td>${report.reporterName}</td>
                    <td>${report.targetName || report.targetId}</td>
                    <td>${report.reason}</td>
                    <td>
                        <span class="status-badge ${report.status === 'RESOLVED' ? 'badge-resolved' : report.status === 'CLOSED' ? 'badge-sold' : 'badge-pending'}">
                            ${report.status}
                        </span>
                    </td>
                    <td>${formatDate(report.createdAt)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewReport(${report.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${report.status === 'PENDING' ? `
                                <button class="btn btn-resolve" onclick="resolveReport(${report.id})">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading reports:', error);
        showNotification('Failed to load reports', 'error');
    }
}

// ==================== UTILITY FUNCTIONS ====================
function getAuthHeaders() {
    return {
        'Authorization': `Bearer ${currentToken}`
    };
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function formatTime(dateString) {
    if (!dateString) return 'Recently';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
    return `${Math.floor(diffMins / 1440)}d ago`;
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showNotification(message, type = 'info') {
    const container = document.getElementById('notificationContainer');
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    container.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.style.animation = 'slideInRight 0.3s reverse';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

function showConfirm(title, message, onConfirm) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmActionBtn').onclick = () => {
        closeModal('confirmModal');
        onConfirm();
    };
    showModal('confirmModal');
}

function logout() {
    console.log("=== User initiated logout ===");
    
    // Only clear admin-related items
    localStorage.removeItem('adminToken');
    localStorage.removeItem('adminInfo');
    
    // Close WebSocket if open
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
    }
    
    // Redirect with a short delay
    setTimeout(() => {
        window.location.href = 'admin-login.html?logout=true';
    }, 300);
}

function loadSection(section) {
    // Update menu
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.menu-item[onclick*="${section}"]`)?.classList.add('active');
    
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(sec => sec.style.display = 'none');
    
    // Show selected section
    const sectionElement = document.getElementById(`${section}Section`);
    if (sectionElement) {
        sectionElement.style.display = 'block';
        
        // Load section data
        switch(section) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'users':
                loadUsers();
                break;
            case 'admins':
                loadAdmins();
                break;
            case 'marketplace':
                loadMarketplace();
                break;
            case 'lostfound':
                loadLostFound();
                break;
            case 'studypartner':
                loadStudyPartners();
                break;
            case 'reports':
                loadReports();
                break;
        }
    }
}

function showAddUserModal() {
    document.getElementById('addUserForm').reset();
    showModal('addUserModal');
}

function showAddAdminModal() {
    document.getElementById('addAdminForm').reset();
    showModal('addAdminModal');
}

function refreshUsers() {
    loadUsers();
    showNotification('Users list refreshed', 'success');
}

function refreshMarketplace() {
    loadMarketplace();
    showNotification('Marketplace refreshed', 'success');
}

function refreshLostFound() {
    loadLostFound();
    showNotification('Lost & Found refreshed', 'success');
}

function refreshStudyPartners() {
    loadStudyPartners();
    showNotification('Study partners refreshed', 'success');
}

function refreshReports() {
    loadReports();
    showNotification('Reports refreshed', 'success');
}

function refreshActivity() {
    loadRecentActivity();
    showNotification('Activity refreshed', 'success');
}

function filterUsers() {
    // Implement client-side filtering
    const search = document.getElementById('userSearch').value.toLowerCase();
    const filter = document.getElementById('userFilter').value;
    
    const rows = document.querySelectorAll('#usersTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const status = row.querySelector('.status-badge')?.textContent;
        
        let show = true;
        
        if (search && !text.includes(search)) {
            show = false;
        }
        
        if (filter === 'active' && status !== 'Active') {
            show = false;
        } else if (filter === 'blocked' && status !== 'Blocked') {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function exportUsers() {
    // Implement CSV export
    showNotification('Export feature coming soon!', 'info');
}

function performGlobalSearch(term) {
    if (term.target.value.length > 2) {
        // Implement global search
        console.log('Searching for:', term.target.value);
    }
}
// ==================== MISSING FUNCTION DEFINITIONS ====================

function viewMarketplaceItem(itemId) {
    console.log("View marketplace item:", itemId);
    showNotification(`Viewing marketplace item ID: ${itemId}`, 'info');
    // You can implement a modal or redirect to view details
}

function deleteMarketplaceItem(itemId) {
    console.log("Delete marketplace item clicked:", itemId);
    showConfirm(
        'Delete Marketplace Item',
        'Delete this marketplace listing?',
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/marketplace/${itemId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification('Marketplace item deleted', 'success');
                    loadMarketplace();
                } else {
                    throw new Error(`Failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete marketplace item', 'error');
            }
        }
    );
}

function viewLostFoundItem(itemId) {
    console.log("View lost/found item:", itemId);
    showNotification(`Viewing lost/found item ID: ${itemId}`, 'info');
    // You can implement a modal or redirect to view details
}

function resolveLostFoundItem(itemId) {
    console.log("Resolve item clicked:", itemId);
    showConfirm(
        'Mark as Resolved',
        'Mark this item as resolved?',
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/items/${itemId}/resolve`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification('Item marked as resolved', 'success');
                    loadLostFound();
                } else {
                    throw new Error(`Failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Resolve error:', error);
                showNotification('Failed to resolve item', 'error');
            }
        }
    );
}

function deleteLostFoundItem(itemId) {
    console.log("Delete lost/found item clicked:", itemId);
    showConfirm(
        'Delete Item',
        'Are you sure you want to delete this lost/found item?',
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/items/${itemId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification('Item deleted successfully', 'success');
                    loadLostFound();
                } else {
                    throw new Error(`Failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete item', 'error');
            }
        }
    );
}

function viewStudyPartner(partnerId) {
    console.log("View study partner:", partnerId);
    showNotification(`Viewing study partner ID: ${partnerId}`, 'info');
    // You can implement a modal or redirect to view details
}

function deleteStudyPartner(partnerId) {
    console.log("Delete study partner clicked:", partnerId);
    showConfirm(
        'Delete Study Partner',
        'Delete this study partner request?',
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/study-partners/${partnerId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification('Study partner deleted', 'success');
                    loadStudyPartners();
                } else {
                    throw new Error(`Failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete study partner', 'error');
            }
        }
    );
}

function viewReport(reportId) {
    console.log("View report:", reportId);
    showNotification(`Viewing report ID: ${reportId}`, 'info');
    // You can implement a modal or redirect to view details
}

function resolveReport(reportId) {
    showConfirm(
        'Resolve Report',
        'Are you sure you want to mark this report as resolved?',
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/reports/${reportId}/resolve`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification('Report marked as resolved', 'success');
                    loadReports();
                } else {
                    throw new Error('Failed to resolve report');
                }
            } catch (error) {
                console.error('Error resolving report:', error);
                showNotification('Failed to resolve report', 'error');
            }
        }
    );
}

function toggleAdminStatus(adminId, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    
    showConfirm(
        `${isActive ? 'Deactivate' : 'Activate'} Admin`,
        `Are you sure you want to ${action} this administrator?`,
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/admins/${adminId}/toggle-status`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification(`Admin ${action}d successfully`, 'success');
                    loadAdmins();
                } else {
                    throw new Error('Failed to update admin status');
                }
            } catch (error) {
                console.error(`Error ${action}ing admin:`, error);
                showNotification(`Failed to ${action} admin`, 'error');
            }
        }
    );
}

function deleteAdmin(adminId) {
    if (currentAdmin.role !== 'SUPER_ADMIN') {
        showNotification('Access denied: Super Admin only', 'error');
        return;
    }
    
    if (adminId === currentAdmin.id) {
        showNotification('Cannot delete your own account', 'error');
        return;
    }
    
    showConfirm(
        'Delete Administrator',
        'Are you sure you want to permanently delete this administrator? This action cannot be undone.',
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/admins/${adminId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification('Admin deleted successfully', 'success');
                    loadAdmins();
                } else {
                    throw new Error('Failed to delete admin');
                }
            } catch (error) {
                console.error('Error deleting admin:', error);
                showNotification('Failed to delete admin', 'error');
            }
        }
    );
}

function viewAdmin(adminId) {
    console.log("View admin:", adminId);
    showNotification(`Viewing admin ID: ${adminId}`, 'info');
    // You can implement a modal or redirect to view details
}

function toggleFeatured(itemId) {
    showConfirm(
        'Toggle Featured',
        'Are you sure you want to toggle featured status for this item?',
        async () => {
            try {
                const response = await fetch(`${ADMIN_API_URL}/marketplace/${itemId}/toggle-featured`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showNotification('Featured status updated', 'success');
                    loadMarketplace();
                } else {
                    throw new Error('Failed to update featured status');
                }
            } catch (error) {
                console.error('Error toggling featured:', error);
                showNotification('Failed to update featured status', 'error');
            }
        }
    );
}

// ==================== END OF MISSING FUNCTIONS ====================

// Initialize dashboard on load
loadSection('dashboard');
</script>
</body>
</html>